<plugin>
	<script>
	import map from '@windy/map'
	import data from './test_data.mjs'
	import createIcon from './icon_create.mjs'
	import UnknownIcon from './icon_unknown.mjs'
	import LandingIcon from './icon_landing.mjs'

    let markers = [];

	const updateIconStyle = () => {
		let zoom = map.getZoom();
		console.log('updateIconStyle, zoom=', zoom);

		for (const marker of markers) {
			if (marker._icon) {
				if (zoom < 8) {
					marker._icon.style.display = 'none';
				} else {
					if (marker.options.type == 'landing' && zoom < 12) {
						marker._icon.style.display = 'none';
					} else {
						marker._icon.style.display = 'block';
					}
				}
			}
		}
	}

    const load = () => {

		console.log('load');

		for (const site of data.gpx.wpt) {
			let icon;
			
			if (site.type == "landing") { // Landings
				icon = LandingIcon;
			} else { // Take-offs
				if (site.cmt && site.cmt.orientations) {
					icon = createIcon(site.cmt.orientations);
				} else {
					icon = UnknownIcon;
				}
			}
			const marker = L.marker([site["-lat"], site["-lon"]], {
								icon: icon,
								title: site.name,
								type: site.type,
								opacity: 0.65,
							}).addTo(map);
			markers.push(marker);
		}
		updateIconStyle();
    }

    const remove = () => {
    	markers.forEach( l => map.removeLayer(l) );
    	markers = [];
    }


    let hasHooks = false

    this.onopen = () => {
    	if (hasHooks) return;

    	load();

	    map.on('zoom', updateIconStyle);
    	map.on('zoomend', updateIconStyle);
    	map.on('viewreset', updateIconStyle);
    	hasHooks = true;

    	map.setView([14, -29], 4);

    }

    this.onclose = () => {
    	if (!hasHooks) return;

    	remove();

	    map.off('zoom', updateIconStyle);
    	map.off('zoomend', updateIconStyle);
    	map.off('viewreset', updateIconStyle);
    	hasHooks = false;
    }

	</script>
</plugin>
