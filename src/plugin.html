<plugin>
	<script>
	import map from '@windy/map'
	import picker from '@windy/picker'
	import broadcast from '@windy/broadcast'
	import utils from '@windy/utils'
	import data from './test_data.mjs'
	import angles from './angles.mjs'
	import OrientedIcon from './icon_oriented.mjs'
	import UnknownIcon from './icon_unknown.mjs'
	import LandingIcon from './icon_landing.mjs'

      let markers = [];

      const updateIconStyle = () => {
        for (const marker of markers) {
          if (marker._icon) {
            const heading = marker._icon.getAttribute('data-heading');
            if (marker._icon.style.transform.indexOf('rotateZ') === -1) {
              marker._icon.style.transform = `${marker._icon.style.transform} rotateZ(${(heading || 0)}deg)`;
            }
          }
        }
      }

    const load = () => {

    	// Get weather infos when picker is moved
		picker.on('pickerMoved', latLon => {
			// picker was dragged by user to latLon coords

			let { lat, lon, values, overlay } = picker.getParams()
			// -> 50.4, 14.3, 'wind', [ U,V, ]

			let windObject = utils.wind2obj( values )
			// { overlay: 'wind', values: [ 0.4, 0.75, 0] }
			console.log(windObject);
		})

		for (const site of data.gpx.wpt) {
			
			if (site.type == "landing") { // Landings
				const marker = L.marker([site["-lat"], site["-lon"]], {
							icon: LandingIcon,
						}).addTo(map);
				markers.push(marker);
			} else { // Take-offs
				if (site.cmt && site.cmt.orientations) {
					// Get weather on this point => move the picker
					broadcast.fire('rqstOpen','picker',{ lat: site["-lat"], lon: site["-lon"] });


					for (const orientation of Object.keys(site.cmt.orientations)) {
						if (site.cmt.orientations[orientation] >= 1) {
							const marker = L.marker([site["-lat"], site["-lon"]], {
								icon: OrientedIcon,
							}).addTo(map);
							marker._icon.setAttribute('data-heading', angles[orientation]);
							markers.push(marker);
						}
					}
				} else {
					const marker = L.marker([site["-lat"], site["-lon"]], {
								icon: UnknownIcon,
							}).addTo(map);
					markers.push(marker);
				}
			}
		}
		updateIconStyle();
    }

    const remove = () => {
    	markers.forEach( l => map.removeLayer(l) );
    	markers = [];
    }


    let hasHooks = false

    this.onopen = () => {
    	if( hasHooks ) return

    	load()

	    map.on('zoom', updateIconStyle)
    	map.on('zoomend', updateIconStyle)
    	map.on('viewreset', updateIconStyle)
    	hasHooks = true

    	map.setView([ 14, -29 ], 4 )

    }

    this.onclose = () => {
    	if(!hasHooks) return

    	remove()

	    map.off('zoom', updateIconStyle)
    	map.off('zoomend', updateIconStyle)
    	map.off('viewreset', updateIconStyle)
    	hasHooks = false
    }

	</script>
</plugin>
